.pag 'ieee'
;atn irq process
; irq on atn, listen to pet
; clear stack 
.ski 3
irq
	ldx #$ff
	stx cmdnum
	txs
	lda atnpe       ;clear irq flag
	lda #davo+eoio
	ora pad2        ;free control lines
	sta pad2
	lda #255
	sta ieeedo      ;free data lines
atn10	lda #daco+rfdo+atna
	ora pad2
	sta pad2
atn20	bit pad2
	bvc atn30       ;dav lo
	bmi atn20       ;atn lo atni hi
	bpl atn50       ;atn hi
atn30	lda #255-rfdo   ;nrfd lo
	and pad2
	sta pad2
	and #eoii
	sta eoiflg      ;save eoi
	lda ieeedi
	eor #$ff
	sta data        ;save command
	lda #255-daco   ;ndac hi
	and pad2
	sta pad2
dcde	ldy #0
	lda data
	and #%01100000
	cmp #$40        ;talk?
	beq dcde60
	cmp #$20        ;listen?
	beq dcde20
	cmp #$60        ;secondary?
	beq dcde70
	bne dcde80      ;other
dcde20	lda data
	cmp lsnadr
	beq dcde40      ;my listen address
	cmp #unlsn
	bne dcde30
	sty lsnact
dcde30	sty adrsed      ;not primary addrsed
	jmp dcde80
dcde40	sta lsnact
	sty tlkact
dcde50	lda #32
	sta sa          ;default sa
	sta orgsa
	sta adrsed      ;primary addressed
	bne dcde80
dcde60	sty tlkact
	lda data
	cmp tlkadr
	bne dcde30
	sta tlkact
	sty lsnact
	beq dcde50
dcde70	lda adrsed
	beq dcde80      ;not addressed
	lda data
	sta orgsa
	pha
	and #$f
	sta sa
	pla
	and #$f0        ;close?
	cmp #$e0
	bne dcde80
	jsr close
dcde80
atn40	bit pad2
	bvc atn40
	jmp atn10
atn50	lda lsnact
	beq atn60
	lda #255-rfdo-atna
	and pad2
	sta pad2
	cli
	jsr listen
	jmp idle
atn60	lda #255-atna-daco
	and pad2
	sta pad2
	lda tlkact
	beq atn70
	cli
	jsr talk
atn70	jmp idle
.ski 5
listen	lda #rfdo       ;rfd: hi
	ora pad2
	sta pad2
lsn10	bit pad2        ;dav: lo
	bvs lsn10
	jsr fndwch      ; was ldx sa
	bcs lsn15
.skip
	lda chnrdy,x
	ror a           ;ok, open for listen
	bcs lsn30
lsn15	lda orgsa       ; was txa
	and #$f0        ;sa=open?
	cmp #$f0
	beq lsn30
lsn20	lda sa
	cmp #1
	beq lsn25
lsn21	bit pad2
	bvc lsn21
	lda #255-daco
	and pad2
	sta pad2
	rts
.skip
lsn25	lda #255-rfdo   ; accept all data
	and pad2
	sta pad2        ;rfd low
	lda #255-daco
	and pad2        ; dac hi
	sta pad2
.skip
lsn26	bit pad2        ; dav hi
	bvc lsn26
	lda #daco
	ora pad2        ; dac low
	sta pad2
	lda #rfdo       ; rfd hi
	ora pad2
	sta pad2
lsn28	bit pad2        ; wait dav low
	bvc lsn28
	jmp lsn25       ; do until atn pulled
lsn30	lda #255-rfdo
	and pad2
	sta pad2
	and #eoii
	sta eoiflg
	lda ieeedi
	eor #$ff
	sta data
	sei
	lda #255-daco
	and pad2
	sta pad2
lsn40	bit pad2
	bvc lsn40
	lda #daco
	ora pad2
	sta pad2
	jsr put
lstrtn	cli
	jmp listen
.ski 3
talk	jsr fndrch 
	bcs notlk       ; test if channel ready
talk1	ldx lindx
	lda chnrdy,x
	bmi tlk10
notlk	rts
tlk10	bit pbd2        ;rfd: hi
	bpl tlk10
	lda chndat,x
	eor #$ff
	sta ieeedo
	lda chnrdy,x
	ora #255-eoio-davo ;dav: lo
	and pad2
	sta pad2
tlk20	bit pbd2
	bpl tlk30
	bvc tlk20
	lda #davo+eoio
	ora pad2
	sta pad2
	jmp idle
tlk30	jsr get
tlk35	bit pbd2
	bvc tlk35
tlkrtn	lda #$ff
	sta ieeedo
	lda #davo+eoio
	ora pad2
	sta pad2
tlk40	bit pbd2
	bvs tlk40
	bvc talk1
.end
