.page 'idle'
.skip3
; idle loop, waiting for something to do
idle	lda cmdwat      ; test for pending command
	beq idl1        ; no command waiting
	sei
	lda #0
	sta cmdwat
	sta nmiflg      ;clear debounce
	jsr parsxq      ; parse and xeq command
idl1	cli             ;test for drive running or openfile
	lda #14
	sta temp+3
	lda #0          ;if file open, turn on act led
	sta temp
	sta temp+1
idl2	ldx temp+3      ;look thru lintab
	lda lintab,x    ;for active file
	cmp #$ff
	beq idl3
	and #$3f
	sta lindx
	jsr getact
	tax
	lda lstjob,x    ;determine which drv it is on
	and #1
	tax
	inc temp,x
idl3	dec temp+3      ;set flag indicating drv
	bpl idl2        ;has file open
	ldy #bfcnt-1    ;look thru job que for
idl4	lda jobs,y      ; for jobs still running
	bpl idl5
	and #1
	tax
	inc temp,x      ;set flag indicating drive
idl5	dey             ;is active
	bpl idl4
	lda ledprt
	and #$ff-led1-led0
	pha
	lda #0
	sta drvnum
	lda temp
	beq idl7
	lda wpsw
	beq idl6
	sei
	jsr cldchn
	cli
idl6
	pla             ;turn on led if drive flag
	ora #led0       ; if not 0
	pha
idl7
	inc drvnum
	lda temp+1
	beq idl9
	lda wpsw+1
	beq idl8
	sei
	jsr cldchn
	cli
idl8
	pla
	ora #led1
	pha
idl9
	pla
	sta ledprt
	jmp idl1        ;back to top of lop
;
.end
